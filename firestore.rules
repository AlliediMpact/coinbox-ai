rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    function isAdmin() {
      return isAuthenticated() && 
             ('admin' in request.auth.token) && 
             request.auth.token.admin == true;
    }
    
    function isSupport() {
      return isAuthenticated() && 
             (('admin' in request.auth.token && request.auth.token.admin == true) ||
              ('support' in request.auth.token && request.auth.token.support == true));
    }
    
    function hasValidTimestamp() {
      return request.resource.data.createdAt == request.time;
    }
    
    // Public collections: allow read for everyone, write for no one
    match /publicData/{document=**} {
      allow read: if true;
      allow write: if false;
    }
    match /stats/{doc} {
      allow read: if true;
      allow write: if false;
    }
    match /publicContent/{doc} {
      allow read: if true;
      allow write: if false;
    }
    match /testimonials/{doc} {
      allow read: if true;
      allow write: if false;
    }
    match /press/{doc} {
      allow read: if true;
      allow write: if false;
    }
    match /education/{doc} {
      allow read: if true;
      allow write: if false;
    }
    match /systemStatus/{doc} {
      allow read: if true;
      allow write: if false;
    }
    match /news/{doc} {
      allow read: if true;
      allow write: if false;
    }
    match /coins/{doc} {
      allow read: if true;
      allow write: if false;
    }

    // Users collection
    match /users/{userId} {
      // Users can read their own data, admins can read all
      allow read: if isOwner(userId) || isAdmin();
      
      // Users can create their own profile during signup
      allow create: if isOwner(userId) && hasValidTimestamp();
      
      // Users can update their own data (except role and membership status)
      allow update: if isOwner(userId) && 
                      !request.resource.data.diff(resource.data).affectedKeys().hasAny(['role', 'membershipStatus', 'membershipTier']);
      
      // Only admins can delete users
      allow delete: if isAdmin();
    }
    
    // User memberships
    match /user_memberships/{userId} {
      allow read: if isOwner(userId) || isSupport();
      allow write: if isAdmin();
    }
    
    // Trading tickets
    match /tickets/{ticketId} {
      // Users can read their own tickets and open tickets
      allow read: if isAuthenticated() && 
                    (resource.data.userId == request.auth.uid || 
                     resource.data.status == 'Open' ||
                     isSupport());
      
      // Users can create tickets for themselves
      allow create: if isAuthenticated() && 
                      request.resource.data.userId == request.auth.uid &&
                      hasValidTimestamp();
      
      // Users can update their own tickets (limited fields)
      allow update: if isAuthenticated() && 
                      resource.data.userId == request.auth.uid &&
                      request.resource.data.diff(resource.data).affectedKeys().hasOnly(['status', 'updatedAt', 'description']);
      
      // Only admins can delete tickets
      allow delete: if isAdmin();
    }
    
    // Transactions
    match /transactions/{transactionId} {
      // Users can only read their own transactions, admins can read all
      allow read: if isAuthenticated() && 
                    (resource.data.userId == request.auth.uid || 
                     resource.data.counterpartyId == request.auth.uid ||
                     isSupport());
      
      // Only system can create transactions (via server-side code)
      allow create: if false;
      
      // No updates or deletes allowed (immutable audit trail)
      allow update, delete: if false;
    }
    
    // Payments
    match /payments/{paymentId} {
      // Users can only read their own payments, support can read all
      allow read: if isAuthenticated() && 
                    (resource.data.userId == request.auth.uid || isSupport());
      
      // Only system can create/update payments (via webhooks)
      allow create, update: if false;
      
      // No deletes (audit trail)
      allow delete: if false;
    }
    
    // Disputes
    match /disputes/{disputeId} {
      // Participants and support can read
      allow read: if isAuthenticated() && 
                    (resource.data.initiatorId == request.auth.uid || 
                     resource.data.respondentId == request.auth.uid ||
                     isSupport());
      
      // Users can create disputes
      allow create: if isAuthenticated() && 
                      request.resource.data.initiatorId == request.auth.uid &&
                      hasValidTimestamp();
      
      // Participants can update (add evidence), admins can resolve
      allow update: if (isAuthenticated() && 
                       (resource.data.initiatorId == request.auth.uid || 
                        resource.data.respondentId == request.auth.uid)) ||
                       isAdmin();
      
      // Only admins can delete
      allow delete: if isAdmin();
    }
    
    // KYC documents
    match /kyc_documents/{documentId} {
      // Users can only read their own documents, support can read all
      allow read: if isAuthenticated() && 
                    (resource.data.userId == request.auth.uid || isSupport());
      
      // Users can create their own KYC documents
      allow create: if isAuthenticated() && 
                      request.resource.data.userId == request.auth.uid &&
                      hasValidTimestamp();
      
      // Users cannot update KYC docs once submitted, only admins can verify
      allow update: if isAdmin();
      
      // Only admins can delete
      allow delete: if isAdmin();
    }
    
    // Notifications
    match /notifications/{notificationId} {
      // Users can only read their own notifications
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
      
      // Only system can create notifications
      allow create: if false;
      
      // Users can mark as read
      allow update: if isAuthenticated() && 
                      resource.data.userId == request.auth.uid &&
                      request.resource.data.diff(resource.data).affectedKeys().hasOnly(['read', 'readAt']);
      
      // Users can delete their own notifications
      allow delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }
    
    // Rate limiting
    match /rateLimits/{limitId} {
      // No direct access - only server-side
      allow read, write: if false;
    }
    
    // Flagged accounts (security)
    match /flaggedAccounts/{userId} {
      // Only admins can read
      allow read: if isAdmin();
      
      // Only system can write
      allow write: if false;
    }
    
    // Audit logs (immutable)
    match /audit_logs/{logId} {
      // Only admins can read audit logs
      allow read: if isAdmin();
      
      // No direct writes (only via server)
      allow create, update, delete: if false;
    }
    
    // System configuration (admins only)
    match /system_config/{configId} {
      allow read: if isAdmin();
      allow write: if isAdmin();
    }
    
    // Commission records
    match /commissions/{commissionId} {
      // Users can read their own commissions
      allow read: if isAuthenticated() && 
                    (resource.data.referrerId == request.auth.uid || isSupport());
      
      // System can create/update commissions via server
      allow create, update: if false;
      
      // No deletes (audit trail)
      allow delete: if false;
    }
    
    // Commission payouts
    match /commission_payouts/{payoutId} {
      // Users can read their own payouts
      allow read: if isAuthenticated() && 
                    (resource.data.referrerId == request.auth.uid || isSupport());
      
      // System only
      allow create, update: if false;
      allow delete: if false;
    }
    
    // Catch-all: deny by default
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
